(function(exports) { 
function ThreeDS(form,apiKey,token,options){this.formId=form||null;this.apiKey=apiKey||null;this.t=token||null;this.token=null;this.ready=false;this.errors=[];this.isRebill=false;this.pid=null;this.transactionId=null;this.defaultRejectHandler=function(error){if(g.options.verbose)console.log(error)};this.options=options||{autoSubmit:true,allowOverride:false,addResultToForm:true,verbose:false,iframeId:"__threeds"+(Math.random()*5E3<<0)};this.options.iframeId=this.options.iframeId||"__threeds"+(Math.random()*
5E3<<0);this.options.verbose=this.options.verbose||false;this.options.allowOverride=this.options.allowOverride||false;this.options.autoSubmit=this.options.autoSubmit!=undefined?this.options.autoSubmit:true;this.options.addResultToForm=this.options.addResultToForm!=undefined?this.options.addResultToForm:true;this.options.eciInputId=this.options.eciInputId||"eci";this.options.cavvInputId=this.options.cavvInputId||"cavv";this.options.xidInputId=this.options.xidInputId||"xid";this.options.statusInputId=
this.options.statusInputId||"status";this.options.rebill=this.options.rebill||false;this.options.endpoint=this.options.endpoint||"https://api.3dsintegrator.com";this.options.resolve=this.options.resolve||false;this.options.reject=this.options.reject||false;this.options.start=this.options.start||false;this.options.prompt=this.options.prompt||false;this.options.showIframe=this.options.showIframe||false;this.options.authorizationComplete=this.options.authorizationComplete||false;this.options.allowRetry=
this.options.allowRetry||false;this.options.popup=this.options.popup||false;var g=this;if(typeof this.options!=="object")throw new Error("invalid options passed");if(this.t==null)this.gt(function(response){if(g.options.authorizationComplete)g.options.authorizationComplete(response)});else this.ready=true;if(this.options.autoSubmit)this.init()}
ThreeDS.prototype={validateConfig:function(){if(!this.formId){console.log("Please specify a form id");return false}if(!this.apiKey){console.log("Please specify an Api Key");return false}var form=document.getElementById(this.formId);if(!form){console.log("Form element "+this.formId+" does not exist");return false}var amountInput=form.querySelector("[data-threeds\x3damount]");var panInput=form.querySelector("[data-threeds\x3dpan]");var monthInput=form.querySelector("[data-threeds\x3dmonth]");var yearInput=
form.querySelector("[data-threeds\x3dyear]");var transactionIdInput=form.querySelector("[data-threeds\x3did]");var ccTokenInput=form.querySelector("[data-threeds\x3dcctoken]");if(transactionIdInput==null||amountInput==null||panInput==null&&ccTokenInput==null||monthInput==null||yearInput==null){if(transactionIdInput==null)console.log("1 element MUST be tagged with the attribute 'data-threeds\x3d\"id\"'");if(amountInput==null)console.log("1 element MUST be tagged with the attribute 'data-threeds\x3d\"amount\"'");
if(panInput==null&&ccTokenInput==null)console.log("1 element MUST be tagged with the attribute 'data-threeds\x3d\"pan\"' OR 'data-threeds\x3d\"cctoken\"'");if(monthInput==null)console.log("1 element MUST be tagged with the attribute 'data-threeds\x3d\"month\"'");if(yearInput==null)console.log("1 element MUST be tagged with the attribute 'data-threeds\x3d\"year\"'");return false}return true},init:function(){if(this.validateConfig()){var form=document.getElementById(this.formId);var g=this;var pan=
form.querySelector("[data-threeds\x3dpan]");var month=form.querySelector("[data-threeds\x3dmonth]");var year=form.querySelector("[data-threeds\x3dyear]");var inputListener=function(event){g.verify(function(response){if(g.options.allowRetry==false){pan.removeEventListener("blur",inputListener);month.removeEventListener("blur",inputListener);year.removeEventListener("blur",inputListener)}if(g.options.resolve)g.options.resolve(response)},g.options.reject)};if(pan!=null)pan.addEventListener("blur",inputListener);
month.addEventListener("blur",inputListener);year.addEventListener("blur",inputListener)}else if(this.options.verbose)console.log("ERROR","Invalid config")},getAuthData:function(data){var form=document.getElementById(this.formId);var amountInput=form.querySelector("[data-threeds\x3damount]");var panInput=form.querySelector("[data-threeds\x3dpan]");var monthInput=form.querySelector("[data-threeds\x3dmonth]");var yearInput=form.querySelector("[data-threeds\x3dyear]");var transactionIdInput=form.querySelector("[data-threeds\x3did]");
var ccTokenInput=form.querySelector("[data-threeds\x3dcctoken]");var shippingFirstName=form.querySelector("[data-threeds\x3dshippingFirstName]");var shippingLastName=form.querySelector("[data-threeds\x3dshippingLastName]");var shippingMethod=form.querySelector("[data-threeds\x3dshippingMethod]");var shippingStreetAddress=form.querySelector("[data-threeds\x3dshippingStreetAddress]");var shippingCity=form.querySelector("[data-threeds\x3dshippingCity]");var shippingState=form.querySelector("[data-threeds\x3dshippingState]");
var shippingZipCode=form.querySelector("[data-threeds\x3dshippingZipCode]");var shippingCountryCode=form.querySelector("[data-threeds\x3dshippingCountryCode]");var emailAddress=form.querySelector("[data-threeds\x3demailAddress]");var billingFirstName=form.querySelector("[data-threeds\x3dbillingFirstName]");var billingLastName=form.querySelector("[data-threeds\x3dbillingLastName]");var sellerType=form.querySelector("[data-threeds\x3dsellerType]");var destinationCode=form.querySelector("[data-threeds\x3ddestinationCode]");
var originCode=form.querySelector("[data-threeds\x3doriginCode]");var departureDate=form.querySelector("[data-threeds\x3ddepartureDate]");var passengerlimit=1;var passengers=[];while(passengerlimit<=20){firstnameData="firstNamePassenger"+passengerlimit;lastNameData="lastNamePassenger"+passengerlimit;var firstname=form.querySelector("[data-threeds\x3d"+firstnameData+"]");var lastname=form.querySelector("[data-threeds\x3d"+lastNameData+"]");if(firstname!=null)passengers.push({firstName:firstname.value,
lastName:lastname.value});passengerlimit++}var amount=data!==undefined&&data.amount!=undefined?parseFloat(data.amount):parseFloat(amountInput.value);if(panInput!=null&&panInput!=="")var pan=data!==undefined&&data.pan!=undefined?""+data.pan:panInput.value.replace(/-|\s/g,"");if(ccTokenInput!=null)var cctoken=data!==undefined&&data.cctoken!=undefined?""+data.cctoken:ccTokenInput.value.replace(/-|\s/g,"");var month=data!==undefined&&data.month!=undefined?parseInt(data.month,10):parseInt(monthInput.value.replace(/-|\s/g,
""),10);var year=data!==undefined&&data.year!=undefined?parseInt(data.year,10):parseInt(yearInput.value,10);if(!isNaN(month))if(monthInput.value.length>2){month=parseInt(monthInput.value.slice(0,2),10);if(isNaN(year))year=parseInt(monthInput.value.slice(-2),10)}var transactionId=data!==undefined&&data.transactionId!=undefined?data.transactionId:transactionIdInput.value;if(this.options.verbose){console.log("amount",amount);console.log("pan",pan);console.log("month",month);console.log("year",year);
console.log("transactionId",transactionId);console.log("cctoken",cctoken)}if(isNaN(month)||isNaN(year)||isNaN(amount))return false;if(cctoken===undefined&&!this.validateCreditCard(pan))return false;if((pan===undefined||pan==="")&&!this.validateCCToken(cctoken))return false;var customData=null;if(shippingMethod!==null)customData={shippingFirstName:shippingFirstName.value,shippingLastName:shippingLastName.value,shippingMethod:shippingMethod.value,emailAddress:emailAddress.value,billingFirstName:billingFirstName.value,
billingLastName:billingLastName.value,sellerType:sellerType.value,passengerInfo:passengers,destinationCode:destinationCode.value,originCode:originCode.value,departureDate:departureDate.value};if(shippingStreetAddress!==null){customData.shippingStreetAddress=shippingStreetAddress.value;customData.shippingCity=shippingCity.value;customData.shippingState=shippingState.value;customData.shippingZipCode=shippingZipCode.value;customData.shippingCountryCode=shippingCountryCode.value}var value={amount:amount,
month:month,year:year,transactionId:transactionId};if(pan!==undefined&&pan!="")value.pan=pan;else if(cctoken!==undefined)value.cardToken=cctoken;if(customData!==null)value.custom=customData;return value},verify:function(resolve,reject,data){var g=this;resolve=resolve||function(response){if(g.options.verbose)console.log(response)};reject=reject||g.defaultRejectHandler;if(g.t===null){g.gt(function(response){if(g.options.authorizationComplete)g.options.authorizationComplete(response);if(g.t!==null)g.verify(resolve,
reject,data)});return}var data=g.getAuthData(data);if(data!==false){if(g.options.start!==false)g.options.start({amount:data.amount,transactionId:data.transactionId});this.ajaxCall(this.options.endpoint+"/authenticate",data,function(xmlhttp){var authenticationInfo=JSON.parse(xmlhttp.response);if(authenticationInfo.Token!==undefined)g.token=authenticationInfo.Token;if(g.options.verbose)console.log("DEBUG","Authentication Info",authenticationInfo);var authorzationHeader=xmlhttp.getResponseHeader("Authorization");
if(authorzationHeader&&authorzationHeader!="")g.t=authorzationHeader.replace("Bearer ","");if(authorzationHeader){console.log("authHeader");if(!resolve)if(g.options.verbose){var err="The resolve callback function must be defined";this.errors.push(err);console.error(err);return}reject=reject||g.defaultRejectHandler;g.transactionId=authenticationInfo.ThreedDSTransactionID;var messageCallBack=function(e){console.log("messageCallBack");if(g.validateResponse(e.data)){clearTimeout(g.pid);if(g.options.addResultToForm)g.insertResults(e.data,
resolve,reject);var tFrame=document.getElementById(g.options.iframeId);if(tFrame!=null&&tFrame.parentNode!=null)tFrame.parentNode.removeChild(tFrame);resolve(e.data,g.isRebill)}else reject(e.data,g.isRebill);window.removeEventListener("message",messageCallBack)};window.addEventListener("message",messageCallBack);if(!g.options.popup){var form=document.getElementById(g.formId);var frame=document.getElementById(g.options.iframeId);if(frame==null){var tframe=document.createElement("iframe");tframe.setAttribute("id",
g.options.iframeId);tframe.setAttribute("style","display:none;");form.parentNode.insertBefore(tframe,form.nextSibling);frame=document.getElementById(g.options.iframeId)}g.setupPromptCheck();frame.addEventListener("load",function(){g.setupPromptCheck()});if(frame!=null)frame.contentDocument.write(""+"\x3chtml\x3e "+"\x3cbody\x3e "+'\x3cform name\x3d"form3ds" action\x3d"'+authenticationInfo.AcsUrl+'" method\x3d"post"\x3e'+'  \x3cinput type\x3d"hidden" name\x3d"PaReq" value\x3d"'+authenticationInfo.PaReq+
'" /\x3e '+'  \x3cinput type\x3d"hidden" name\x3d"TermUrl" value\x3d"'+authenticationInfo.TermUrl+'" /\x3e '+'  \x3cinput type\x3d"hidden" name\x3d"MD" value\x3d"'+authenticationInfo.MD+'" /\x3e '+'  \x3cinput type\x3d"submit" value\x3d"submit" /\x3e '+"\x3c/form\x3e "+'\x3cscript type\x3d"text/javascript"\x3e '+"document.createElement('form').submit.call(document.form3ds); "+"\x3c/script\x3e "+"\x3c/body\x3e "+"\x3c/html\x3e")}else{if(g.options.verbose)console.log("DEBUG","Open in new window "+g.options.endpoint+
"/authenticate/challenge/"+g.transactionId);var popupWindow=window.open(g.options.endpoint+"/authenticate/challenge/"+g.transactionId,"3dspopup","toolbar\x3dno,location\x3dno,status\x3dno,menubar\x3dno,scrollbars\x3dno,resizable\x3dyes,width\x3d600,height\x3d600");var tries=0;var rid=setInterval(function(){g.ajaxCall(g.options.endpoint+"/authenticate/response",{ThreedDSTransactionID:g.transactionId},function(response){var data=JSON.parse(response.response);g.insertResults(data,resolve,reject);clearInterval(rid);
popupWindow.close()},function(error){console.log("ERROR",error);tries++;if(tries>=2){clearInterval(rid);popupWindow.close()}})},8E3)}if(g.options.verbose)console.log("DEBUG","Form Submitted")}},function(xmlhttp){reject(xmlhttp.response)})}},insertResults:function(data,resolve,reject){var eci,cavv,xid,status;g=this;var form=document.getElementById(g.formId);if(g.isRebill===true){eci=form.querySelector("[name\x3drebill_"+g.options.eciInputId+"]");cavv=form.querySelector("[name\x3drebill_"+g.options.cavvInputId+
"]");xid=form.querySelector("[name\x3drebill_"+g.options.xidInputId+"]");status=form.querySelector("[name\x3drebill_"+g.options.statusInputId+"]")}else{eci=form.querySelector("[name\x3d"+g.options.eciInputId+"]");cavv=form.querySelector("[name\x3d"+g.options.cavvInputId+"]");xid=form.querySelector("[name\x3d"+g.options.xidInputId+"]");status=form.querySelector("[name\x3d"+g.options.statusInputId+"]")}if(eci==null||cavv==null||xid==null){var td=document.createElement("div");if(g.isRebill===true){if(eci==
null)td.innerHTML+='\x3cinput type \x3d"hidden" name\x3d"rebill_'+g.options.eciInputId+'" value\x3d"" /\x3e';if(cavv==null)td.innerHTML+='\x3cinput type \x3d"hidden" name\x3d"rebill_'+g.options.cavvInputId+'" value\x3d"" /\x3e';if(xid==null)td.innerHTML+='\x3cinput type \x3d"hidden" name\x3d"rebill_'+g.options.xidInputId+'" value\x3d"" /\x3e';if(status==null)td.innerHTML+='\x3cinput type \x3d"hidden" name\x3d"rebill_'+g.options.statusInputId+'" value\x3d"" /\x3e'}else{if(eci==null)td.innerHTML+='\x3cinput type \x3d"hidden" name\x3d"'+
g.options.eciInputId+'" value\x3d"" /\x3e';if(cavv==null)td.innerHTML+='\x3cinput type \x3d"hidden" name\x3d"'+g.options.cavvInputId+'" value\x3d"" /\x3e';if(xid==null)td.innerHTML+='\x3cinput type \x3d"hidden" name\x3d"'+g.options.xidInputId+'" value\x3d"" /\x3e';if(status==null)td.innerHTML+='\x3cinput type \x3d"hidden" name\x3d"'+g.options.statusInputId+'" value\x3d"" /\x3e'}form.appendChild(td);if(g.isRebill===true){eci=form.querySelector("[name\x3drebill_"+g.options.eciInputId+"]");cavv=form.querySelector("[name\x3drebill_"+
g.options.cavvInputId+"]");xid=form.querySelector("[name\x3drebill_"+g.options.xidInputId+"]");status=form.querySelector("[name\x3drebill_"+g.options.statusInputId+"]")}else{eci=form.querySelector("[name\x3d"+g.options.eciInputId+"]");cavv=form.querySelector("[name\x3d"+g.options.cavvInputId+"]");xid=form.querySelector("[name\x3d"+g.options.xidInputId+"]");status=form.querySelector("[name\x3d"+g.options.statusInputId+"]")}}var authenticationResponse={eci:"",cavv:"",xid:"",status:""};for(var i in data)authenticationResponse[i]=
data[i];if(g.options.verbose){console.log("eci",authenticationResponse.eci);console.log("cavv",authenticationResponse.cavv);console.log("xid",authenticationResponse.xid);console.log("status",authenticationResponse.status)}eci.value=authenticationResponse.eci;cavv.value=authenticationResponse.cavv;xid.value=authenticationResponse.xid;status.value=authenticationResponse.status;if(g.options.rebill&&g.isRebill===false){g.isRebill=true;g.verify(resolve,reject,{"amount":g.options.rebill})}},setupPromptCheck:function(){if(this.pid!==
null)clearTimeout(this.pid);var g=this;this.pid=setTimeout(function(){if(g.options.verbose)console.log("user prompted");if(g.options.showIframe){var frame=document.getElementById(g.options.iframeId);frame.setAttribute("style","display:block;")}if(g.options.prompt!==false)g.options.prompt()},8E3)},valid:function(amount,cardNumber,expirationMonth,expirationYear,transactionId){this.errors=[];return this.validateCreditCard(cardNumber)&&parseInt(Number(expirationMonth),10)==expirationMonth},validateCreditCard:function(creditCard){if(this.options.verbose)console.log("DEBUG",
"validating info");if(!creditCard||isNaN(creditCard)||parseInt(Number(creditCard),10)!=creditCard||creditCard.toString().length<15){this.errors.push("Invalid info");if(this.options.verbose)console.log("ERROR","Invalid info");return false}return true},validateCCToken:function(token){return true},validateResponse:function(response){return true},gt:function(onAuthorize){var g=this;if(this.t==null)this.ajaxCall(this.options.endpoint+"/authorize",null,function(response){if(g.options.verbose){console.log("DEBUG",
"Token Received");console.log("DEBUG","Authorization",response.getResponseHeader("Authorization"))}var authorzationHeader=response.getResponseHeader("Authorization");if(authorzationHeader&&authorzationHeader!==""){g.t=authorzationHeader.replace("Bearer ","");g.ready=true}onAuthorize()},function(response){console.log("ERROR",response.responseText)})},ajaxCall:function(endpoint,data,success,failure){var xhttp=new XMLHttpRequest;var g=this;xhttp.addEventListener("load",function(){if(xhttp.status>=400){console.log("load failure");
failure(xhttp)}else{console.log("load success");success(xhttp)}});xhttp.addEventListener("error",function(){failure(xhttp)});xhttp.open("POST",endpoint,true);xhttp.setRequestHeader("Content-Type","application/json");xhttp.setRequestHeader("X-3DS-API-KEY",this.apiKey);if(this.t!=null)xhttp.setRequestHeader("Authorization","Bearer "+this.t);xhttp.send(JSON.stringify(data))}};
 exports.ThreeDS = ThreeDS;})(this);